<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Gestão</title>
    <link rel="stylesheet" href="/styles/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%2300008B' d='M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm320 96c0-26.9-16.5-49.9-40-59.3L280 88c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 204.7c-23.5 9.5-40 32.5-40 59.3c0 35.3 28.7 64 64 64s64-28.7 64-64zM144 176a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm-16 80a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 32a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM400 144a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z'/></svg>">
    <style>
        .password-input-container {
            position: relative;
            width: 100%;
        }
        .password-input-container input {
            padding-right: 40px;
            width: 100%;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* Estilos para notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 5s forwards;
            border-left: 4px solid #F44336;
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 18px;
            color: #F44336;
        }
        
        .notification.error {
            border-left: 4px solid #F44336;
        }
        
        .notification.error i {
            color: #F44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        
        /* Estilo para o botão de login em estado de carregamento */
        .login-button {
            position: relative;
            overflow: hidden;
        }
        
        .login-button .button-text {
            transition: all 0.3s ease;
        }
        
        .login-button.loading .button-text {
            opacity: 0;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }
        
        .login-button.loading .loading-spinner {
            display: block;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <form id="loginForm" class="login-form">
            <div class="form-header">
                <div class="header-icon">
                    <img src="/assets/logo.png" alt="Logo do Sistema" class="login-logo" style="max-width: 90px; width: 100%; height: auto; display: block; margin: 0 auto; background: rgba(255,255,255,0.08); border-radius: 50%; box-shadow: 0 2px 10px rgba(102, 126, 234, 0.10); border: 2px solid rgba(255,255,255,0.18); padding: 0.7rem;">
                </div>
                <h2>Bem-vindo ao Gasf</h2>
                <p>Acesse sua conta para continuar</p>
            </div>
            <div class="form-group">
                <label for="email">Usuário</label>
                <input type="text" id="email" name="email" class="form-control" placeholder="Digite seu usuário" required>
            </div>
            <div class="form-group">
                <label for="password">Senha</label>
                <div class="password-input">
                    <input type="password" id="password" name="password" required placeholder="Digite sua senha">
                    <button 
                        type="button" 
                        id="toggleSenha" 
                        class="toggle-password" 
                        title="Mostrar ou ocultar senha"
                        aria-label="Mostrar ou ocultar senha">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="checkbox-container">
                    <input type="checkbox" id="remember">
                    <span class="checkmark"></span>
                    Lembrar usuário
                </label>
            </div>
            <button type="submit" class="login-button">
                <span class="button-text">Entrar</span>
                <div class="loading-spinner"></div>
            </button>
        </form>
    </div>

    <script>
        // Função para mostrar notificações
        function showNotification(message, type = 'error') {
            // Remover notificações existentes
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remover notificação após 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const togglePassword = document.getElementById('toggleSenha');
            const passwordInput = document.getElementById('password');
            const loginButton = document.querySelector('.login-button');
            
            // Verificar conexão com o servidor
            checkServerConnection();
            
            // Toggle de mostrar/ocultar senha
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.innerHTML = type === 'password' ? 
                        '<i class="fas fa-eye" aria-hidden="true"></i>' : 
                        '<i class="fas fa-eye-slash" aria-hidden="true"></i>';
                    this.setAttribute('title', type === 'password' ? 'Mostrar senha' : 'Ocultar senha');
                    this.setAttribute('aria-label', type === 'password' ? 'Mostrar senha' : 'Ocultar senha');
                });
            }
            
            // Função para verificar a conexão com o servidor
            async function checkServerConnection() {
                try {
                    const response = await fetch('https://gasf-app.onrender.com/api/auth/login', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        // Timeout de 5 segundos
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Status do servidor:', data.message);
                    } else {
                        console.error('Servidor respondeu com erro:', response.status);
                        showNotification('O servidor está online, mas com problemas. Status: ' + response.status, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao verificar conexão com o servidor:', error);
                    
                    // Adicionar um delay de 10 segundos antes de mostrar a notificação de erro de conexão
                    setTimeout(() => {
                        showNotification('Não foi possível conectar ao servidor. Verifique se o servidor está rodando.', 'error');
                    }, 10000); // 10 segundos de delay
                }
            }
            
            // Manipulação do formulário de login
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const remember = document.getElementById('remember').checked;
                    
                    // Mostrar estado de carregamento
                    if (loginButton) {
                        loginButton.classList.add('loading');
                        loginButton.disabled = true;
                    }
                    
                    try {
                        const response = await fetch('https://gasf-app.onrender.com/api/auth/status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email, password }),
                        });

                        // Remover estado de carregamento
                        if (loginButton) {
                            loginButton.classList.remove('loading');
                            loginButton.disabled = false;
                        }

                        if (!response.ok) {
                            const errorData = await response.json();
                            
                            // Verificar se o erro é devido a usuário desativado
                            if (errorData.message.toLowerCase().includes('desativ')) {
                                showNotification('Usuário desativado. Entre em contato com o administrador.', 'error');
                            } else {
                                showNotification(errorData.message || 'Erro ao fazer login. Verifique suas credenciais.', 'error');
                            }
                            return;
                        }

                        const data = await response.json();
                        console.log('Dados do login:', data);

                        // Verificar se o usuário está ativo
                        if (data.user && data.user.isActive === false) {
                            showNotification('Usuário desativado. Entre em contato com o administrador.', 'error');
                            return;
                        }

                        // Salvar dados do usuário
                        if (data.user) {
                            const userData = {
                                ...data.user,
                                name: data.user.name || data.user.nome || email.split('@')[0]
                            };
                            localStorage.setItem('currentUser', JSON.stringify(userData));
                            localStorage.setItem('user', JSON.stringify(userData));
                            console.log('Dados salvos:', userData);
                        }

                        // Salvar token
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                        }

                        // Gerenciar email lembrado
                        if (remember) {
                            localStorage.setItem('rememberedEmail', email);
                        } else {
                            localStorage.removeItem('rememberedEmail');
                        }

                        // Redirecionar para o dashboard
                        window.location.href = '/dashboard';
                    } catch (error) {
                        console.error('Erro ao fazer login:', error);
                        
                        // Remover estado de carregamento
                        if (loginButton) {
                            loginButton.classList.remove('loading');
                            loginButton.disabled = false;
                        }
                        
                        // Verificar se é um erro de conexão
                        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                            showNotification('Erro de conexão. Verifique se o servidor está rodando.', 'error');
                        } else {
                            showNotification('Erro ao fazer login. Tente novamente mais tarde.', 'error');
                        }
                    }
                });
            }

            // Restaurar email lembrado
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                const emailInput = document.getElementById('email');
                if (emailInput) {
                    emailInput.value = savedEmail;
                    document.getElementById('remember').checked = true;
                }
            }
        });
    </script>
</body>
</html> 
